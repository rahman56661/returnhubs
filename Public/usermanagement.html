<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Management System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* INDUSTRIAL THEME CSS - Matching Organization Details */
        :root {
            --primary-color: #cccccc;
            --secondary-color: #999999;
            --accent-color: #ff4444;
            --dark-bg: #1a1a1a;
            --dark-surface: #2a2a2a;
            --dark-card: #222222;
            --light-text: #e6e6e6;
            --muted-text: #888888;
            --border-color: #444444;
            --success-color: #44ff44;
            --warning-color: #ffaa00;
            --border-radius: 6px;
            --box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            --code-font: 'Arial', sans-serif;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: var(--code-font);
        }

        body {
            background: var(--dark-bg);
            min-height: 100vh;
            color: var(--light-text);
        }

        .header {
            background: var(--dark-surface);
            color: var(--primary-color);
            padding: 30px;
            text-align: center;
            position: relative;
            overflow: hidden;
            border-bottom: 1px solid var(--border-color);
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, var(--accent-color), var(--warning-color));
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .nav-menu {
            background: var(--dark-surface);
            padding: 15px 20px;
            box-shadow: var(--box-shadow);
            display: flex;
            gap: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .nav-menu a {
            text-decoration: none;
            color: var(--muted-text);
            padding: 12px 20px;
            border-radius: var(--border-radius);
            transition: all 0.3s ease;
            font-weight: 600;
            border: 1px solid var(--border-color);
            text-transform: uppercase;
            letter-spacing: 1.5px;
        }

        .nav-menu a:hover,
        .nav-menu a.active {
            background: linear-gradient(90deg, var(--accent-color), var(--warning-color));
            color: var(--dark-bg);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(255, 68, 68, 0.4);
            border-color: var(--accent-color);
        }

        .content-area {
            padding: 30px;
            min-height: calc(100vh - 160px);
        }

        .page-content {
            background: var(--dark-card);
            padding: 40px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            max-width: 1200px;
            margin: 0 auto;
            border: 1px solid var(--border-color);
            position: relative;
            overflow: hidden;
        }

        .page-content::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, var(--accent-color), var(--warning-color));
        }

        .back-btn {
            background: linear-gradient(to bottom, #555 0%, #444 50%, #333 100%);
            color: var(--light-text);
            border: 1px solid #444;
            padding: 10px 20px;
            border-radius: var(--border-radius);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
            text-transform: uppercase;
            letter-spacing: 1.5px;
        }

        .back-btn:hover {
            background: linear-gradient(to bottom, #666 0%, #555 50%, #444 100%);
            border-color: var(--accent-color);
            box-shadow: 0 4px 15px rgba(255, 68, 68, 0.4);
            transform: translateY(-2px);
        }

        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .content-header h2 {
            color: var(--primary-color);
            font-size: 1.8rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-primary {
            background: linear-gradient(90deg, var(--accent-color), var(--warning-color));
            color: var(--dark-bg);
            box-shadow: 0 4px 15px rgba(255, 68, 68, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 68, 68, 0.5);
            background: linear-gradient(90deg, var(--warning-color), var(--accent-color));
        }

        .btn-danger {
            background: linear-gradient(to bottom, #ff4444 0%, #cc3333 50%, #aa2222 100%);
            color: var(--light-text);
            border: 1px solid #cc3333;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }

        .btn-danger:hover {
            background: linear-gradient(to bottom, #ff5555 0%, #dd4444 50%, #bb3333 100%);
            border-color: var(--accent-color);
            box-shadow: 0 4px 15px rgba(255, 68, 68, 0.4);
            transform: translateY(-2px);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: var(--dark-surface);
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--box-shadow);
            border: 1px solid var(--border-color);
        }

        th,
        td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            background: rgba(255, 68, 68, 0.2);
            color: var(--primary-color);
            font-weight: 600;
            text-transform: uppercase;
        }

        tr:hover {
            background: rgba(255, 68, 68, 0.1);
        }

        .action-buttons {
            display: flex;
            gap: 10px;
        }

        .action-buttons button {
            padding: 8px 12px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: var(--dark-card);
            padding: 30px;
            border-radius: var(--border-radius);
            width: 500px;
            max-width: 90%;
            box-shadow: var(--box-shadow);
            border: 1px solid var(--border-color);
            position: relative;
            overflow: hidden;
        }

        .modal-content::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, var(--accent-color), var(--warning-color));
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .modal-header h2 {
            color: var(--primary-color);
            text-transform: uppercase;
        }

        .close {
            font-size: 24px;
            cursor: pointer;
            color: var(--muted-text);
        }

        .close:hover {
            color: var(--accent-color);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--muted-text);
            text-transform: uppercase;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            background: var(--dark-surface);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 16px;
            color: var(--light-text);
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(255, 68, 68, 0.2);
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        .password-match {
            color: var(--success-color);
            font-size: 14px;
            margin-top: 5px;
            display: none;
        }

        .password-mismatch {
            color: var(--accent-color);
            font-size: 14px;
            margin-top: 5px;
            display: none;
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: var(--muted-text);
        }

        .no-data i {
            font-size: 50px;
            margin-bottom: 15px;
            color: var(--border-color);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-info img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid var(--accent-color);
        }

        /* Status Badges */
        .status-badge {
            padding: 6px 12px;
            border-radius: var(--border-radius);
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
            min-width: 120px;
            text-align: center;
            text-transform: uppercase;
        }

        .status-online {
            background: rgba(68, 255, 68, 0.2);
            color: var(--success-color);
            border: 1px solid var(--success-color);
        }

        .status-offline {
            background: rgba(255, 68, 68, 0.2);
            color: var(--accent-color);
            border: 1px solid var(--accent-color);
        }

        .status-never {
            background: rgba(136, 136, 136, 0.2);
            color: var(--muted-text);
            border: 1px solid var(--muted-text);
        }

        /* Role Badges */
        .badge {
            padding: 4px 12px;
            border-radius: var(--border-radius);
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .badge-super-admin {
            background: linear-gradient(90deg, var(--accent-color), var(--warning-color));
            color: var(--dark-bg);
        }

        .badge-admin {
            background: linear-gradient(to bottom, #555 0%, #444 50%, #333 100%);
            color: var(--light-text);
            border: 1px solid #444;
        }

        .badge-user {
            background: var(--dark-bg);
            color: var(--light-text);
            border: 1px solid var(--border-color);
        }

        /* Last Activity Column */
        .last-activity {
            font-size: 12px;
            color: var(--muted-text);
            font-family: 'Courier New', monospace;
            white-space: nowrap;
        }

        /* Current User Label */
        .current-user-label {
            color: var(--accent-color);
            font-weight: 600;
            font-size: 12px;
            padding: 4px 8px;
            background: rgba(255, 68, 68, 0.1);
            border-radius: 4px;
            margin-left: 8px;
        }

        /* Responsive styles */
        @media (max-width: 768px) {
            .content-header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .action-buttons {
                flex-direction: column;
            }

            .nav-menu {
                flex-direction: column;
                gap: 10px;
            }

            .header h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>

<body>
    <div class="header">
        <h1>🏭 Returnhubs System</h1>
        <div class="user-info">
            <img src="https://ui-avatars.com/api/?name=Admin+User&background=random" alt="Admin">
            <span>Welcome, <strong><span id="usernameDisplay">User</span></strong></span>
        </div>
    </div>

    <div class="nav-menu">
        <a href="/dashboard">🏠 Dashboard</a>
        <a href="/organizations">🏢 Organizations</a>
        <a href="/usermanagement" class="active">👥 Users</a>
    </div>

    <div class="content-area">
        <div class="page-content">
            <a href="/dashboard" class="back-btn"><i class="fas fa-arrow-left"></i> Back to Dashboard</a>

            <div class="content-header">
                <h2>User Management</h2>
                <button class="btn btn-primary" id="addUserBtn">
                    <i class="fas fa-plus"></i> Add New User
                </button>
            </div>

            <table class="users-table">
                <thead>
                    <tr>
                        <th>Username</th>
                        <th>Email</th>
                        <th>Role</th>
                        <th>Status</th>
                        <th>Last Activity</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="usersTableBody">
                    <!-- Dynamic content -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Add/Edit User Modal -->
    <div class="modal" id="userModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Add New User</h2>
                <span class="close">&times;</span>
            </div>
            <form id="userForm">
                <div class="form-group">
                    <label for="username">Username</label>
                    <input type="text" id="username" placeholder="Enter username" required>
                </div>
                <div class="form-group">
                    <label for="email">Email Address</label>
                    <input type="email" id="email" placeholder="Enter email address" required>
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <div style="position: relative;">
                        <input type="password" id="password" placeholder="Enter password" required>
                        <i class="fas fa-eye" id="togglePassword"
                            style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); cursor: pointer; color: var(--muted-text);"></i>
                    </div>
                </div>
                <div class="form-group">
                    <label for="confirmPassword">Confirm Password</label>
                    <div style="position: relative;">
                        <input type="password" id="confirmPassword" placeholder="Confirm password" required>
                        <i class="fas fa-eye" id="toggleConfirmPassword"
                            style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); cursor: pointer; color: var(--muted-text);"></i>
                        <div class="password-match" id="passwordMatch">Passwords match!</div>
                        <div class="password-mismatch" id="passwordMismatch">Passwords do not match!</div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="role">Role</label>
                    <select id="role" required>
                        <option value="">Select Role</option>
                        <option value="admin">Administrator</option>
                        <option value="user">User</option>
                    </select>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn" id="cancelBtn">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="saveUserBtn">Save User</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal" id="deleteModal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h2>Confirm Delete</h2>
                <span class="close" id="closeDeleteModal">&times;</span>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this user?</p>
            </div>
            <div class="modal-footer">
                <button class="btn" id="cancelDelete">Cancel</button>
                <button class="btn btn-danger" id="confirmDelete">Delete</button>
            </div>
        </div>
    </div>

    <script>
        // Store users in memory (in a real app, this would be a server/database)
        let users = [];
        let editingUserId = null;
        let userToDelete = null;

        // DOM elements
        const modal = document.getElementById('userModal');
        const addUserBtn = document.getElementById('addUserBtn');
        const closeBtn = document.querySelector('.close');
        const cancelBtn = document.getElementById('cancelBtn');
        const userForm = document.getElementById('userForm');
        const usersTableBody = document.getElementById('usersTableBody');
        const passwordInput = document.getElementById('password');
        const confirmPasswordInput = document.getElementById('confirmPassword');
        const passwordMatch = document.getElementById('passwordMatch');
        const passwordMismatch = document.getElementById('passwordMismatch');
        const saveUserBtn = document.getElementById('saveUserBtn');
        const usernameDisplay = document.getElementById('usernameDisplay');

        // Delete modal elements
        const deleteModal = document.getElementById('deleteModal');
        const closeDeleteModal = document.getElementById('closeDeleteModal');
        const cancelDelete = document.getElementById('cancelDelete');
        const confirmDelete = document.getElementById('confirmDelete');

        // Get current user
        let currentUser = JSON.parse(sessionStorage.getItem('currentUser') || localStorage.getItem('currentUser') || '{"id":"admin","username":"Admin User"}');
        usernameDisplay.textContent = currentUser.username;

        // ✅ ADD MISSING FUNCTIONS
        function renderUsers() {
            console.log('📊 Rendering users...');
            renderUsersRealTime(); // Use the real-time version
        }

        function initializeUserManagement() {
            console.log('🚀 Initializing user management...');
            loadCurrentUser();
            loadRoleBasedUI();
            renderUsersRealTime();
        }

        async function loadUsers() {
            try {
                console.log('🔄 Auto-refresh: Loading users...');
                await renderUsersRealTime();
            } catch (err) {
                console.error('❌ Auto-refresh error:', err);
                setTimeout(loadUsers, 10000);
            }
        }

        // Modal functionality
        addUserBtn.addEventListener('click', () => {
            editingUserId = null;
            userForm.reset();
            document.getElementById('modalTitle').textContent = 'Add New User';
            modal.style.display = 'flex';
            hidePasswordMessages();
        });

        closeBtn.addEventListener('click', () => {
            modal.style.display = 'none';
        });

        cancelBtn.addEventListener('click', () => {
            modal.style.display = 'none';
        });

        // Password validation
        confirmPasswordInput.addEventListener('input', validatePassword);
        passwordInput.addEventListener('input', validatePassword);

        function validatePassword() {
            if (passwordInput.value && confirmPasswordInput.value) {
                if (passwordInput.value === confirmPasswordInput.value) {
                    passwordMatch.style.display = 'block';
                    passwordMismatch.style.display = 'none';
                    saveUserBtn.disabled = false;
                } else {
                    passwordMatch.style.display = 'none';
                    passwordMismatch.style.display = 'block';
                    saveUserBtn.disabled = true;
                }
            } else {
                hidePasswordMessages();
                saveUserBtn.disabled = !passwordInput.value || !confirmPasswordInput.value;
            }
        }

        function hidePasswordMessages() {
            passwordMatch.style.display = 'none';
            passwordMismatch.style.display = 'none';
            saveUserBtn.disabled = false;
        }

        // Auto-refresh user status every 30 seconds
        function startAutoRefresh() {
            setInterval(() => {
                if (window.location.pathname.includes('user-management')) {
                    loadUsers();
                }
            }, 30000);
        }

        // ✅ ADD HEARTBEAT FOR CURRENT USER
        function startActivityHeartbeat() {
            setInterval(() => {
                if (window.location.pathname.includes('user-management')) {
                    fetch('/api/activity-heartbeat', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    }).catch(err => console.log('Heartbeat failed:', err));
                }
            }, 30000);
        }

        // ✅ SINGLE DOMContentLoaded EVENT
        document.addEventListener('DOMContentLoaded', function () {
            console.log('🚀 User Management Page Loaded');
            initializeUserManagement();
            startAutoRefresh();
            startActivityHeartbeat();
        });

        async function renderUsersRealTime() {
            try {
                const response = await fetch('/api/users/status');
                const result = await response.json();

                if (!result.success) throw new Error(result.message);

                usersTableBody.innerHTML = '';

                if (!result.users || result.users.length === 0) {
                    usersTableBody.innerHTML = `
                    <tr class="no-data-row">
                        <td colspan="6">
                            <div class="no-data">
                                <i class="fas fa-users"></i>
                                <h3>No Users Found</h3>
                                <p>Click "Add New User" to create your first user</p>
                            </div>
                        </td>
                    </tr>`;
                    return;
                }

                // ✅ GET CURRENT USER INFO
                let currentUsername = '';
                try {
                    const userResponse = await fetch('/api/get-user-info');
                    const userResult = await userResponse.json();
                    if (userResult.success) currentUsername = userResult.username;
                } catch (err) {
                    console.error('Error getting current user:', err);
                }

                // ✅ RENDER EACH USER WITH REAL-TIME STATUS
                result.users.forEach(user => {
                    const isCurrentUser = user.username === currentUsername;

                    const row = document.createElement('tr');
                    row.innerHTML = `
                    <td>${user.username} ${isCurrentUser ? '<span class="current-user-label">(You)</span>' : ''}</td>
                    <td>${user.email}</td>
                    <td><span class="badge ${user.role === 'super_admin' ? 'badge-super-admin' : user.role === 'admin' ? 'badge-admin' : 'badge-user'}">${user.role ? user.role.charAt(0).toUpperCase() + user.role.slice(1).replace('_', ' ') : 'User'}</span></td>
                    <td><span class="status-badge ${user.status.includes('🟢') ? 'status-online' : user.status.includes('🔴') ? 'status-offline' : 'status-never'}">${user.status}</span></td>
                    <td class="last-activity">${user.lastActivity}</td>
                    <td class="action-buttons">${!isCurrentUser ? `<button class="btn-danger" onclick="showDeleteConfirmation('${user._id}')"><i class="fas fa-trash"></i> Delete</button>` : '<span class="current-user-label">Current User</span>'}</td>`;
                    usersTableBody.appendChild(row);
                });

                console.log('✅ REAL-TIME Rendering complete - Users:', result.users.length);
            } catch (err) {
                console.error('❌ REAL-TIME Render error:', err);
                usersTableBody.innerHTML = `<tr class="no-data-row"><td colspan="6"><div class="no-data"><i class="fas fa-exclamation-triangle"></i><h3>Error Loading Users</h3><p>Please refresh the page</p></div></td></tr>`;
            }
        }

        // Get current user info from API
        async function loadCurrentUser() {
            try {
                const response = await fetch('/api/get-user-info');
                const result = await response.json();

                if (result.success) {
                    currentUser = {
                        id: result._id || result.userId,
                        username: result.username,
                        role: result.role,
                        organizationId: result.organizationId
                    };

                    document.getElementById('usernameDisplay').textContent = currentUser.username;
                    const userAvatar = document.querySelector('.user-info img');
                    if (userAvatar) {
                        userAvatar.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(currentUser.username)}&background=random`;
                    }
                    sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
                }
            } catch (err) {
                console.error('Error loading current user:', err);
                const storedUser = sessionStorage.getItem('currentUser');
                if (storedUser) {
                    currentUser = JSON.parse(storedUser);
                    document.getElementById('usernameDisplay').textContent = currentUser.username;
                }
            }
        }

        async function loadRoleBasedUI() {
            try {
                const response = await fetch('/api/get-user-info');
                const userInfo = await response.json();

                if (userInfo.success) {
                    const userRole = userInfo.role;
                    if (userRole === 'user') {
                        document.getElementById('addUserBtn').style.display = 'none';
                        document.querySelector('h2').textContent = 'User List (View Only)';
                        document.querySelectorAll('.action-buttons').forEach(btn => btn.style.display = 'none');
                    }
                    if (userRole === 'admin' || userRole === 'user') {
                        document.querySelectorAll('[href*="organization"]').forEach(link => link.style.display = 'none');
                    }
                }
            } catch (error) {
                console.error('Error loading role-based UI:', error);
            }
        }

        document.getElementById('togglePassword').addEventListener('click', () => {
            const input = document.getElementById('password');
            input.type = input.type === 'password' ? 'text' : 'password';
        });

        document.getElementById('toggleConfirmPassword').addEventListener('click', () => {
            const input = document.getElementById('confirmPassword');
            input.type = input.type === 'password' ? 'text' : 'password';
        });

        // Form submission
        userForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            console.log('📝 Form submitted - Starting user creation...');

            if (passwordInput.value !== confirmPasswordInput.value) {
                alert('❌ Passwords do not match!');
                return;
            }

            const userData = {
                username: document.getElementById('username').value,
                email: document.getElementById('email').value,
                password: document.getElementById('password').value,
                role: document.getElementById('role').value
            };

            console.log('📦 User data to send:', userData);

            try {
                const token = getAuthToken();
                const response = await fetch('/api/users', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify(userData)
                });

                console.log('📡 Response status:', response.status);
                const result = await response.json();
                console.log('📊 Server response:', result);

                if (result.success) {
                    alert('✅ User created successfully in your organization!');
                    renderUsersRealTime();
                    modal.style.display = 'none';
                    userForm.reset();
                } else {
                    alert('❌ Error: ' + result.message);
                }
            } catch (err) {
                console.error('❌ Network error:', err);
                alert('Server error, please try again');
            }
        });

        function getAuthToken() {
            return localStorage.getItem('token') || sessionStorage.getItem('token') || localStorage.getItem('authToken') || 'mock-token-for-testing';
        }

        // Delete confirmation modal functions
        function showDeleteConfirmation(userId) {
            userToDelete = userId;
            deleteModal.style.display = 'flex';
        }

        function hideDeleteConfirmation() {
            deleteModal.style.display = 'none';
            userToDelete = null;
        }

        closeDeleteModal.addEventListener('click', hideDeleteConfirmation);
        cancelDelete.addEventListener('click', hideDeleteConfirmation);

        confirmDelete.addEventListener('click', async () => {
            if (!userToDelete) return;
            try {
                const response = await fetch(`/api/users/${userToDelete}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${getAuthToken()}` }
                });
                const result = await response.json();
                if (result.success) {
                    users = users.filter(u => u._id !== userToDelete);
                    renderUsersRealTime();
                    alert('✅ User deleted successfully from organization!');
                } else {
                    alert('❌ ' + result.message);
                }
            } catch (err) {
                console.error(err);
                alert('Server error, please try again');
            } finally {
                hideDeleteConfirmation();
            }
        });

        window.addEventListener('click', (e) => {
            if (e.target === modal) modal.style.display = 'none';
            if (e.target === deleteModal) hideDeleteConfirmation();
        });
    </script>
</body>

</html>